<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Protegemed - TM4C </title>

<link href="semantic/dist/semantic.min.css" rel="stylesheet" type="text/css">

<!--
<script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>
-->

<script src="node_modules/jquery/dist/jquery.min.js"> </script>
<script src="semantic/dist/semantic.min.js"></script>
<script src="semantic/dist/icon.min.js"></script>

<script src="/socket.io/socket.io.js"></script>

<script src="node_modules/chart.js/dist/Chart.bundle.js"> </script>
<script src="node_modules/chart.js/samples/utils.js"> </script>

<script>

const MAIN_MENU_ITEM1 = 'Menu1';
const MAIN_MENU_ITEM2 = 'Menu2';
const MAIN_MENU_ITEM3 = 'Menu3';
const MAIN_MENU_ITEM4 = 'Menu4';

const ACTIVE_PAGE1 = 'Page1';
const ACTIVE_PAGE2 = 'Page2';
const ACTIVE_PAGE3 = 'Page3';
const ACTIVE_PAGE4 = 'Page4';

const TIME_INTERVAL_TM4C_ALIVE_SIGNAL = 2000; // in miliseconds

const BASE_FREQUENCY = 60;
const SAMPLE_POINTS = 256;
const SAMPLE_FREQUENCY = BASE_FREQUENCY*SAMPLE_POINTS;

/**
* 
******************* General Initialization 
*
*/
$(document).ready(function() {
	
		menuHandler(MAIN_MENU_ITEM1);
		aliveSignalTM4C(); 
		
		//plot([],[],'graphDataSample','Reconstructed Wave Form', 'rgba(75,192,192,0.4)');
		
	});
	
	/**
	*
	*---------- Menu Handler
	*
	*/
	function menuHandler(active)
	{
	console.log('Menu active: '+active);
		switch(active)
			{
				case MAIN_MENU_ITEM1:{
					document.getElementById(MAIN_MENU_ITEM1).className='item active';
					document.getElementById(ACTIVE_PAGE1).style.display='block';
					document.getElementById(MAIN_MENU_ITEM2).className='item';
					document.getElementById(ACTIVE_PAGE2).style.display='none';
					document.getElementById(MAIN_MENU_ITEM3).className='item';
					document.getElementById(ACTIVE_PAGE3).style.display='none';
					document.getElementById(MAIN_MENU_ITEM4).className='item';
					document.getElementById(ACTIVE_PAGE4).style.display='none';
					break;
			}
					case MAIN_MENU_ITEM2:{
					document.getElementById(MAIN_MENU_ITEM1).className='item';
					document.getElementById(ACTIVE_PAGE1).style.display='none';
					document.getElementById(MAIN_MENU_ITEM2).className='item active';
					document.getElementById(ACTIVE_PAGE2).style.display='block';
					document.getElementById(MAIN_MENU_ITEM3).className='item';
					document.getElementById(ACTIVE_PAGE3).style.display='none';
					document.getElementById(MAIN_MENU_ITEM4).className='item';
					document.getElementById(ACTIVE_PAGE4).style.display='none';
					break;
					}
					case MAIN_MENU_ITEM3:{
					document.getElementById(MAIN_MENU_ITEM1).className='item';
					document.getElementById(ACTIVE_PAGE1).style.display='none';
					document.getElementById(MAIN_MENU_ITEM2).className='item ';
					document.getElementById(ACTIVE_PAGE2).style.display='none';
					document.getElementById(MAIN_MENU_ITEM3).className='item active';
					document.getElementById(ACTIVE_PAGE3).style.display='block';
					document.getElementById(MAIN_MENU_ITEM4).className='item';
					document.getElementById(ACTIVE_PAGE4).style.display='none';
					break;
					}
					case MAIN_MENU_ITEM4:{
					document.getElementById(MAIN_MENU_ITEM1).className='item';
					document.getElementById(ACTIVE_PAGE1).style.display='none';
					document.getElementById(MAIN_MENU_ITEM2).className='item';
					document.getElementById(ACTIVE_PAGE2).style.display='none';
					document.getElementById(MAIN_MENU_ITEM3).className='item';
					document.getElementById(ACTIVE_PAGE3).style.display='none';
					document.getElementById(MAIN_MENU_ITEM4).className='item active';
					document.getElementById(ACTIVE_PAGE4).style.display='block';
					break;
					}
			}
		
	}
	/**
	* 
	******************* Socket process for TM4C threads
	*
	*/
	var socket = io();
	var num=0;
	var index=0;
	var receivedCount=0;
	var sampledPhase=[];
	var sampledDiff=[];
	var sampledVoltage=[];
	//sampledData[0]=0;
	var totalTime=[];
	//totalTime[0]=0;
	sampledPhase[0]=0;
	sampledDiff[0]=0;
	sampledVoltage[0]=0;
	socket.on("TM4CAnswer", function(data) {
		//console.log('TM4C Answered: ' + data);	
		var res = JSON.parse(data);
		var Phase_real = res.SIN_P.split(';');
		var Phase_img = res.COS_P.split(';');
		var Diff_real = res.SIN_D.split(';');
		var Diff_img = res.COS_D.split(';');
		var Voltage_real = res.SIN_V.split(';');
		var Voltage_img = res.COS_V.split(';');
		console.log('Real length: ' + Phase_real.length );
		var signal=[],time=[];
		receivedCount++;
		for(var i=0; i<SAMPLE_POINTS; i++)
		{
			signal[i] = 0;
			time[i] = i * (1/SAMPLE_FREQUENCY); 
			totalTime[index]= index * (1/SAMPLE_FREQUENCY); 
			sampledPhase[index]=0;
			sampledDiff[index]=0;
			sampledVoltage[index]=0;
			for(var j=0; j<Phase_real.length; j++)
			{
				var amp = Math.sqrt(Math.pow(hex2float(Phase_real[j]),2)+Math.pow(hex2float(Phase_img[j]),2))/(SAMPLE_POINTS/2);
				var ang = Math.atan2(hex2float(Phase_img[j]),hex2float(Phase_real[j]));	
				sampledPhase[index] =  sampledPhase[index] + (amp * Math.cos(2*Math.PI*time[i]*(j+1)*BASE_FREQUENCY + ang));
				//sampledPhase[index]=signal[i];
				
				var amp = Math.sqrt(Math.pow(hex2float(Diff_real[j]),2)+Math.pow(hex2float(Diff_img[j]),2))/(SAMPLE_POINTS/2);
				var ang = Math.atan2(hex2float(Diff_img[j]),hex2float(Diff_real[j]));	
				sampledDiff[index] =  sampledDiff[index] + (amp * Math.cos(2*Math.PI*time[i]*(j+1)*BASE_FREQUENCY + ang));
				//sampledDiff[index]=signal[i];
				
				var amp = Math.sqrt(Math.pow(hex2float(Voltage_real[j]),2)+Math.pow(hex2float(Voltage_img[j]),2))/(SAMPLE_POINTS/2);
				var ang = Math.atan2(hex2float(Voltage_img[j]),hex2float(Voltage_real[j]));	
				sampledVoltage[index] =  sampledVoltage[index] + (amp * Math.cos(2*Math.PI*time[i]*(j+1)*BASE_FREQUENCY + ang));
				//sampledVoltage[index]=signal[i];
			}
			index++;
		}
		console.log('\nReceived Count: '+ receivedCount);
		/*for(var i=0; i<SAMPLE_POINTS; i++)
		{
			time[i] = time[i]*1000; 
			time[i] = time[i].toFixed(2);
		}*/
		
		//var graph = document.createElement('canvas');
		//var graphId = 'graph' + num++;
		//console.log('graph id: ' + graphId);
		//graph.id=graphId;
		//document.body.appendChild(graph);
		//document.getElementById("graphPlace").appendChild(graph);
		
				
		//plot(time,signal,graphId,'Reconstructed Wave Form', 'rgba(75,192,192,0.4)');		
		//console.log('signal: '+ signal);
		//document.getElementById("statusHeader").innerText="TM4C Answer: " + data;
		console.log('num: ' + num);
		console.log('\nReceived Count: '+ receivedCount);
		if(++num>9)
		{
		
		for(var i=0; i<totalTime.length; i++)
		{
			totalTime[i] = totalTime[i]*1000; 
			totalTime[i] = totalTime[i].toFixed(2);
		}
			
			//var graph = document.createElement('canvas');
			//var graphId = 'graph' + num++;
			//console.log('graph id: ' + graphId);
			//graph.id=graphId;
			//document.getElementById("graphPlace").remove(graph);
			//document.body.appendChild(graph);
			//document.getElementById("graphPlace").appendChild(graph);
			plot2(totalTime,sampledPhase,sampledDiff,'graphDataSample','Reconstructed Wave Form');
			//plot(totalTime,sampledDiff,'graphDataSample','Reconstructed Wave Form','red');
			num=0;
			index=0;
			totalTime=[];
			sampledPhase=[];
			sampledDiff=[];
			sampledPhase[0]=0;
			sampledDiff[0]=0;
			sampledVoltage[0]=0;
			//console.log('total time: ' + totalTime);
		}
	});
	
	
	socket.on("aliveFromTM4C", function(data) {		
		if(data=='Alive')
			{
			var con = document.getElementById("aliveLabel");
			con.setAttribute('class','ui green label');
			con.text="TM4C connected"; 
			document.getElementById("btnStart").disabled = false;
			}
		else if(data=='Dead')
			{
			var con = document.getElementById("aliveLabel");
			con.setAttribute('class','ui red label');
			con.text="TM4C offline";
			document.getElementById("btnStart").disabled = true;
			
			}
	});
		
	
	/*
	*
	*---------- Execution Time funtcions, create HTML objects
	*
	*/
	function createFrequencyTable(){
				
				var table = document.createElement('table');
				table.setAttribute('id','frequencyTable');
				table.setAttribute('class','ui striped blue table');	
			for (var i = 1; i < 29; i++){
				if(i==1){
					var caption = document.createElement('caption'); 
					table.appendChild(caption);
				}
				var tr = document.createElement('tr');   
				var td = [];
				var text = [];
				for(var j=1; j<8; j++){
					if(i==1){
					td[j] = document.createElement('th');
					text[j] = document.createTextNode('');
					td[j].appendChild(text[j]);
					tr.appendChild(td[j]);	
					}
					else{
					td[j] = document.createElement('td');
					text[j] = document.createTextNode('');
					td[j].appendChild(text[j]);
					tr.appendChild(td[j]);
					}
				}	
				table.appendChild(tr);
			}
			document.getElementById('frequencyTablePlace').appendChild(table);
		
	}
	
	
	/*
	*
	*---------- Plot functions
	*
	*/
	function plot(x,y,graph,label,color){
			var ctx = document.getElementById(graph).getContext('2d');
			var myChart = new Chart(ctx, {
				  type: 'line',
				  data: {
				    labels: x,
				    datasets: [{
				      label: label,
				      data: y,
				      fill: false,
			            lineTension: 0.1,
			            backgroundColor: color,//"rgba(75,192,192,0.4)",
			            borderColor: color,//"rgba(75,192,192,1)",
			            borderCapStyle: 'butt',
			            borderDash: [],
			            borderDashOffset: 0.0,
			            borderJoinStyle: 'miter',
			            pointBorderColor: color,//"rgba(75,192,192,1)",
			            pointBackgroundColor: "#fff",
			            pointBorderWidth: 1,
			            pointHoverRadius: 5,
			            pointHoverBackgroundColor: "rgba(75,192,192,1)",
			            pointHoverBorderColor: "rgba(220,220,220,1)",
			            pointHoverBorderWidth: 2,
			            pointRadius: 1,
			            pointHitRadius: 10,
						responsive: true,	
						xAxes:[{
						  scaleLabel: {
							display: true,
							labelString: 'probability'
						  }
						}]
				  	}]
				  }
				}); 
		
		}	
	function plot2(x,y1,y2,graph,label){
		var ctx = document.getElementById(graph).getContext('2d');
		var myChart = new Chart(ctx, {
			  type: 'line',
			  data:{
				    labels: x,
				     datasets: [{
				         label: "Phase Current",
				         borderColor: window.chartColors.blue,
				         backgroundColor: window.chartColors.blue,
				         fill: false,
				         data: y1
				         //yAxisID: "y-axis-1",
				     }, {
				         label: "Voltage",
				         borderColor: window.chartColors.red,
				         backgroundColor: window.chartColors.red,
				         fill: false,
				         data:y2
				         //yAxisID: "y-axis-2"
				     }]
			  },
			  options: {
		             responsive: true,
		             hoverMode: 'index',
		             stacked: false,
					 lineTension: 1,
					 pointRadius: 0,
					 pointHitRadius: 0,
					 cubicInterpolationMode: 'default',
					 elements: {
								point:{
								radius: 0
								}
					},
		             title:{
		                 display: true,
		                 text:label
		             },
		             scales: {
		                 yAxes: [{
		                     type: "linear", // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
		                     display: true,
		                     position: "left",
		                     id: "y-axis-1",
		                     gridLines: {
		                         drawOnChartArea: true, // only want the grid lines for one axis to show up
		                     },
							 pointRadius: 0,
		                 }
 		                 ,
		                 {
		                     type: "linear", // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
		                     display: true,
		                     position: "right",
		                     id: "y-axis-2",
		                     // grid line settings
		                     gridLines: {
		                         drawOnChartArea: false, // only want the grid lines for one axis to show up
		                     }, 
							 pointRadius: 0,
		                 }
		                 ],
		             }
		         }
			}); 
	}	
	
	
	// Request signal of life from TM4C
	var aliveTimer
	function aliveSignalTM4C() {
		aliveTimer = setInterval(function(){ 
		socket.emit('TM4CDeadAlive');//alert("Hello"); 
		}, TIME_INTERVAL_TM4C_ALIVE_SIGNAL);
	}
	
	
	function fcnGenerateFail()
	{
		socket.emit('GenerateFail');//alert("Hello"); 
	}
	
	function hex2float(n){
	  n = '0x' + n;
	  var sign = (n >> 31) * 2 + 1; // +1 or -1.
	  var exp = (n >>> 23) & 0xff;
	  var mantissa = n & 0x007fffff;
	  if (exp === 0xff) {
		// NaN or Infinity
		return mantissa ? NaN : sign * Infinity;

	  }
	  else if (exp) {
		// Normalized value
		exp -= 127;

		// Add implicit bit in normal mode.
		mantissa |= 0x00800000;
	  }
	  else {
		// Subnormal number
		exp = -126;
	  }
	  return sign * mantissa * Math.pow(2, exp - 23);
	}
	
</script>

</head>

<body>

<h2 class="ui center aligned header">
	Protegemed - TM4C and Node.js - Beta Version
</h2>
	<h3 id="statusHeader" class="ui green center aligned block header">
  				........ 
	</h3>

<div class="ui grid">
	<div class="two wide column">
	<a class="ui red label" id="aliveLabel">TM4C offline</a>
		<div id="mainMenu" class="ui vertical huge fluid tabular menu">
		  <div id='Menu1' class="item active" onClick="menuHandler('Menu1')">
			SoftKey1
		  </div>
		  <a id='Menu2' class="item" onClick="menuHandler('Menu2')">SoftKey2 </a>
		  <a id='Menu3' class="item" onClick="menuHandler('Menu3')">SoftKey3</a>
		  <a id='Menu4' class="item" onClick="menuHandler('Menu4')">SoftKey4</a>
		</div>
		
	</div>
	
	<div class="twelve wide stretched column">
	
		<div id='Page1' class="ui segment" >
			<div class="ui segment">
				<button id="btnGenerateFail" class="ui primary button" onClick="fcnGenerateFail()">
				  Generate Fail
				</button>
			</div>
				
			<div id="graphPlace" class="ui segment">	
				<canvas id="graphDataSample"></canvas>
			</div>
		</div>

		<div id='Page2' class="ui segment">
			
		</div>
		
		<div id='Page3' class="ui segment">
						
		</div>
	
		<div id='Page4' class="ui segment">
			
		</div>
	
	</div>
</div>


</body>
</html>